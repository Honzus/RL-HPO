from scipy.stats import bootstrap
import matplotlib.pyplot as plt
from matplotlib.patches import Patch
from scipy.stats import wilcoxon
import pandas as pd
import numpy as np
import seaborn as sns

def sr_ci(rewards, k, threshold=0.95, ci=0.95, n_resamples=9_999, rng_seed=42):
    global_max = rewards.max(axis=1, keepdims=True)
    hit = (rewards[:, :k] >= threshold * global_max).any(axis=1).astype(float)
    res = bootstrap((hit,), np.mean, n_resamples=n_resamples,
                    confidence_level=ci, random_state=rng_seed, method='percentile')
    return {
        'mean': hit.mean(),
        'ci_low': res.confidence_interval.low,
        'ci_high': res.confidence_interval.high
    }

def gpc(rewards, k, threshold=0.95):
    global_max = rewards.max(axis=1, keepdims=True)
    return (rewards[:, :k] >= threshold * global_max).sum(axis=1)

def get_best_performance(array):
    return np.max(array, axis=1)  # Max performance per run

def trials_to_95_percent(array, i):
    # Best performance for the method: max across all runs and trials
    best_perf = np.max(array)

    trials_list = []
    for run in array:
        # Find the first trial (1-based) where performance >= 0.95 * best
        reached = np.where(run >= 0.95 * best_perf)[0]
        if len(reached) > 0:
            trials = reached[0] + 1  # 1-based index
        else:
            trials = len(run)  # If never reached, set to max trials + 1
        trials_list.append(trials)

    return np.array(trials_list)

bo_10_sp = np.array([[0.778, 0.784, 0.779, 0.798, 0.79, 0.776, 0.785, 0.772, 0.7809999999999999, 0.7759999999999999], [0.7699999999999999, 0.772, 0.764, 0.777, 0.768, 0.772, 0.766, 0.77, 0.788, 0.773], [0.783, 0.772, 0.7779999999999999, 0.783, 0.7819999999999999, 0.79, 0.7879999999999999, 0.785, 0.778, 0.79], [0.799, 0.777, 0.7779999999999999, 0.785, 0.768, 0.784, 0.776, 0.776, 0.78, 0.7819999999999998], [0.7889999999999999, 0.792, 0.775, 0.7729999999999999, 0.782, 0.788, 0.7790000000000001, 0.776, 0.773, 0.7769999999999999]])

bo_10_cm = np.array([[0.5980000000000001, 0.9675, 1.0470000000000002, 0.1925, 1.2195, 0.0, 0.018, 0.34049999999999997, 0.0, 0.521], [0.1715, 0.0, 0.8825, 0.513, 0.3225, 0.3675, 0.16899999999999998, 0.0, 0.20800000000000002, 1.0550000000000002], [1.721, 0.8515, 1.396, 1.203, 1.0245, 0.5065, 0.53, 0.3205, 1.5815, 1.722], [0.3435, 0.5305, 0.324, 0.8850000000000001, 0.0, 0.0, 1.0435, 0.525, 0.0, 0.8785000000000001], [1.342, 0.3205, 1.5875000000000001, 1.734, 0.44000000000000006, 1.565, 0.0, 0.6845, 0.0, 0.0]])

rs_10_sp = np.array([[0.7729999999999999, 0.78, 0.778, 0.757, 0.7849999999999999, 0.781, 0.774, 0.7770000000000001, 0.783, 0.777], [0.77, 0.772, 0.771, 0.773, 0.8, 0.792, 0.767, 0.78, 0.78, 0.774], [0.7979999999999999, 0.789, 0.777, 0.777, 0.768, 0.7689999999999999, 0.783, 0.774, 0.7849999999999999, 0.78], [0.776, 0.7819999999999999, 0.7699999999999999, 0.7809999999999999, 0.782, 0.769, 0.779, 0.7770000000000001, 0.774, 0.776], [0.78, 0.775, 0.783, 0.7950000000000002, 0.78, 0.782, 0.7769999999999999, 0.775, 0.776, 0.775]])

rs_10_cm = np.array([[0.47400000000000003, 0.9324999999999999, 0.3785, 0.024, 1.212, 0.696, 0.0, 0.1765, 0.0, 0.0], [0.192, 0.0, 0.9950000000000001, 1.1960000000000002, 0.509, 0.374, 0.363, 0.0, 0.8240000000000001, 0.8425], [1.6789999999999998, 1.2375, 0.7205000000000001, 0.9075, 1.559, 0.37750000000000006, 0.316, 0.8460000000000001, 0.29900000000000004, 1.3705000000000003], [0.3545, 0.357, 0.33199999999999996, 0.0, 0.0, 0.0, 0.8665, 0.3625, 0.0, 0.327], [1.0580000000000003, 0.663, 1.5619999999999998, 1.6949999999999998, 0.6685000000000001, 1.7325, 0.0, 0.5575, 0.0, 0.0]])

dqn_10_cm = np.array([
        [1.402, 0.000, 1.744, 1.674, 1.403, 1.722, 1.552, 1.713, 1.683, 1.541],
        [0.342, 0.000, 1.706, 1.687, 1.057, 1.695, 1.734, 1.353, 1.682, 1.391],
        [0.334, 0.000, 1.713, 0.504, 1.200, 1.736, 1.736, 1.739, 1.731, 1.698],
        [1.727, 0.000, 1.695, 1.662, 1.232, 1.679, 1.718, 1.169, 1.419, 1.565],
        [1.219, 1.347, 0.565, 1.183, 1.711, 1.359, 0.000, 1.736, 1.527, 1.537]
    ])

dqn_10_sp = np.array([[0.789, 0.774, 0.78, 0.773, 0.786, 0.763, 0.791, 0.787, 0.775, 0.77], [0.776, 0.767, 0.776, 0.785, 0.777, 0.782, 0.777, 0.777, 0.788, 0.782], [0.773, 0.784, 0.771, 0.774, 0.775, 0.796, 0.776, 0.78, 0.797, 0.78], [0.783, 0.78, 0.778, 0.777, 0.777, 0.782, 0.772, 0.789, 0.797, 0.778], [0.775, 0.782, 0.799, 0.777, 0.787, 0.782, 0.772, 0.798, 0.79, 0.785]])

rs_50_sp = np.array([[0.781, 0.772, 0.781, 0.782, 0.7769999999999999, 0.774, 0.772, 0.77, 0.775, 0.788, 0.775, 0.79, 0.7849999999999999, 0.7569999999999999, 0.78, 0.772, 0.78, 0.775, 0.78, 0.774, 0.771, 0.783, 0.774, 0.788, 0.795, 0.774, 0.78, 0.789, 0.78, 0.798, 0.793, 0.7839999999999999, 0.781, 0.79, 0.778, 0.78, 0.7809999999999999, 0.7979999999999999, 0.78, 0.778, 0.782, 0.7770000000000001, 0.7789999999999999, 0.78, 0.795, 0.788, 0.787, 0.789, 0.799, 0.791], [0.7779999999999999, 0.772, 0.772, 0.78, 0.7849999999999999, 0.778, 0.776, 0.782, 0.783, 0.7769999999999999, 0.7859999999999999, 0.791, 0.784, 0.7779999999999999, 0.768, 0.773, 0.8, 0.776, 0.778, 0.773, 0.7730000000000001, 0.779, 0.784, 0.782, 0.767, 0.7790000000000001, 0.779, 0.788, 0.79, 0.78, 0.767, 0.7769999999999999, 0.766, 0.786, 0.767, 0.783, 0.78, 0.769, 0.781, 0.791, 0.789, 0.7749999999999999, 0.7969999999999999, 0.78, 0.776, 0.7869999999999999, 0.7859999999999999, 0.769, 0.776, 0.776], [0.774, 0.773, 0.7959999999999999, 0.788, 0.7779999999999999, 0.782, 0.773, 0.766, 0.7659999999999999, 0.776, 0.786, 0.784, 0.776, 0.778, 0.792, 0.787, 0.778, 0.7789999999999999, 0.779, 0.783, 0.79, 0.7979999999999999, 0.797, 0.777, 0.7689999999999999, 0.7849999999999999, 0.7689999999999999, 0.7899999999999999, 0.7939999999999999, 0.775, 0.792, 0.7809999999999999, 0.766, 0.776, 0.776, 0.78, 0.7709999999999999, 0.776, 0.79, 0.776, 0.7939999999999999, 0.776, 0.784, 0.7790000000000001, 0.793, 0.777, 0.7870000000000001, 0.779, 0.79, 0.7669999999999999], [0.776, 0.7819999999999999, 0.787, 0.777, 0.782, 0.776, 0.795, 0.794, 0.7790000000000001, 0.758, 0.785, 0.784, 0.778, 0.7739999999999999, 0.7790000000000001, 0.781, 0.792, 0.789, 0.784, 0.7779999999999999, 0.766, 0.7849999999999999, 0.78, 0.786, 0.779, 0.7859999999999999, 0.7809999999999999, 0.7809999999999999, 0.785, 0.782, 0.7789999999999999, 0.776, 0.7790000000000001, 0.783, 0.784, 0.778, 0.772, 0.796, 0.781, 0.7779999999999999, 0.7689999999999999, 0.7869999999999999, 0.77, 0.778, 0.772, 0.778, 0.785, 0.776, 0.782, 0.771], [0.792, 0.8030000000000002, 0.786, 0.793, 0.7760000000000001, 0.795, 0.781, 0.789, 0.777, 0.7769999999999999, 0.763, 0.774, 0.7779999999999999, 0.7870000000000001, 0.782, 0.779, 0.785, 0.792, 0.7869999999999999, 0.79, 0.7859999999999999, 0.776, 0.781, 0.7859999999999999, 0.762, 0.78, 0.788, 0.7709999999999999, 0.7769999999999999, 0.791, 0.78, 0.773, 0.775, 0.798, 0.78, 0.776, 0.789, 0.79, 0.7899999999999999, 0.774, 0.766, 0.768, 0.7860000000000001, 0.782, 0.776, 0.788, 0.7849999999999999, 0.773, 0.793, 0.769]])

rs_50_cm = np.array([[0.1835, 1.0350000000000001, 0.20550000000000002, 0.018, 1.421, 0.6945, 0.0, 0.0, 0.0, 0.0, 0.53, 0.156, 0.3365, 0.0185, 0.5075000000000001, 0.20299999999999999, 0.46950000000000003, 0.0, 0.0, 0.843, 0.344, 1.7465000000000004, 0.6865, 1.3904999999999998, 0.709, 0.8549999999999999, 1.436, 1.3505, 1.2095, 1.5619999999999998, 1.232, 1.7254999999999998, 0.2745, 1.6985, 1.7429999999999999, 1.363, 0.333, 1.7555, 1.704, 1.044, 1.0605, 0.1695, 1.052, 1.7235, 0.0, 0.353, 0.46299999999999997, 1.3875, 1.718, 1.6934999999999998], [0.8584999999999999, 0.0, 1.3504999999999998, 1.0165, 0.493, 0.8535, 0.08549999999999999, 0.0, 0.35750000000000004, 0.33999999999999997, 0.154, 0.5525, 0.17099999999999999, 0.6875, 0.0, 0.346, 0.9745000000000001, 1.3565, 0.3305, 0.0, 0.02, 0.2125, 0.32999999999999996, 1.6864999999999999, 1.5399999999999998, 0.0, 0.33849999999999997, 1.706, 1.7150000000000003, 0.019, 0.3245, 1.393, 0.0, 0.8550000000000001, 0.019, 1.5625, 0.325, 1.1885, 1.1125, 0.3305, 0.358, 1.0295, 0.1975, 0.186, 0.8965, 0.0, 0.3635, 1.0725, 0.8455, 0.0], [1.6794999999999998, 1.1915, 1.017, 0.1765, 1.4065, 0.7230000000000001, 0.0, 1.062, 1.06, 1.551, 1.686, 1.7130000000000003, 0.0, 1.012, 0.5055, 1.1955, 0.8655000000000002, 1.1880000000000002, 0.9014999999999999, 0.5295, 1.212, 1.5625000000000002, 0.344, 0.1865, 0.0, 1.7365, 0.48100000000000004, 1.714, 1.5310000000000001, 0.0, 0.1875, 1.3615, 0.525, 1.401, 1.2035, 0.513, 0.5585, 0.0, 1.7710000000000001, 1.343, 1.6810000000000003, 1.216, 0.6675, 0.5565, 1.515, 1.7014999999999998, 0.20049999999999998, 0.697, 0.5175, 0.716], [0.514, 0.3665, 0.1845, 0.0, 0.0, 0.0, 1.0685, 0.529, 0.0, 1.0550000000000002, 0.875, 1.3965, 0.0, 1.6634999999999998, 0.1795, 0.517, 0.0, 1.6955000000000002, 0.6545, 1.2315, 1.0310000000000001, 0.9175000000000001, 0.179, 1.394, 0.865, 1.3699999999999999, 1.7045000000000001, 0.873, 0.3135, 0.020499999999999997, 0.3745, 0.32799999999999996, 1.078, 0.341, 1.3954999999999997, 0.5135, 0.7155, 1.7025, 0.0, 1.3704999999999998, 0.7575000000000001, 0.19549999999999998, 1.0085, 1.707, 0.0, 0.21800000000000003, 0.6625, 0.019, 1.207, 1.0615], [0.35, 0.025, 1.3699999999999999, 1.7195, 1.174, 1.4335, 0.0, 0.5469999999999999, 0.0, 0.0, 0.1945, 0.0185, 0.6705, 1.022, 1.3575000000000002, 0.0, 1.1969999999999998, 0.0, 0.6555000000000001, 0.49800000000000005, 0.6925, 1.3829999999999998, 1.015, 1.6920000000000002, 0.177, 1.0535, 1.3955000000000002, 1.7100000000000002, 0.8615, 0.909, 1.0225, 0.47400000000000003, 0.6935, 1.5595, 1.2120000000000002, 0.185, 0.3545, 0.0, 0.3825, 0.3155, 0.196, 0.8865000000000001, 0.0185, 0.0, 0.36, 1.332, 0.0, 1.0539999999999998, 1.3515000000000001, 1.217]])

bo_50_sp = np.array([[0.766, 0.7700000000000001, 0.79, 0.789, 0.788, 0.7630000000000001, 0.782, 0.767, 0.774, 0.7699999999999999, 0.7830000000000001, 0.776, 0.779, 0.775, 0.776, 0.774, 0.7749999999999999, 0.772, 0.7889999999999999, 0.781, 0.793, 0.772, 0.772, 0.772, 0.7859999999999999, 0.792, 0.7809999999999999, 0.772, 0.772, 0.78, 0.788, 0.7879999999999999, 0.766, 0.772, 0.784, 0.772, 0.7979999999999999, 0.787, 0.784, 0.773, 0.772, 0.768, 0.772, 0.7630000000000001, 0.772, 0.772, 0.772, 0.772, 0.772, 0.775], [0.7689999999999999, 0.772, 0.775, 0.793, 0.762, 0.7929999999999999, 0.7790000000000001, 0.772, 0.781, 0.775, 0.772, 0.7769999999999999, 0.787, 0.777, 0.772, 0.772, 0.7829999999999999, 0.773, 0.772, 0.772, 0.772, 0.795, 0.789, 0.759, 0.772, 0.772, 0.772, 0.7689999999999999, 0.789, 0.7769999999999999, 0.78, 0.772, 0.7779999999999999, 0.785, 0.7699999999999999, 0.772, 0.778, 0.772, 0.772, 0.773, 0.783, 0.7899999999999999, 0.772, 0.779, 0.772, 0.786, 0.778, 0.772, 0.772, 0.766], [0.7689999999999999, 0.784, 0.7830000000000001, 0.767, 0.784, 0.7929999999999999, 0.785, 0.78, 0.7799999999999999, 0.768, 0.772, 0.7819999999999999, 0.7869999999999999, 0.778, 0.772, 0.788, 0.772, 0.795, 0.7779999999999999, 0.787, 0.773, 0.779, 0.774, 0.79, 0.791, 0.785, 0.773, 0.7809999999999999, 0.782, 0.7929999999999999, 0.7999999999999999, 0.792, 0.782, 0.792, 0.798, 0.8039999999999999, 0.775, 0.772, 0.772, 0.767, 0.772, 0.7849999999999999, 0.792, 0.779, 0.772, 0.772, 0.79, 0.792, 0.771, 0.7799999999999999], [0.782, 0.7580000000000001, 0.789, 0.768, 0.7790000000000001, 0.771, 0.7909999999999999, 0.7779999999999999, 0.774, 0.7780000000000001, 0.772, 0.779, 0.772, 0.786, 0.776, 0.794, 0.777, 0.777, 0.766, 0.774, 0.79, 0.772, 0.776, 0.7779999999999999, 0.775, 0.7849999999999999, 0.772, 0.772, 0.778, 0.783, 0.774, 0.7540000000000001, 0.776, 0.793, 0.789, 0.782, 0.772, 0.774, 0.784, 0.792, 0.77, 0.772, 0.7770000000000001, 0.772, 0.772, 0.769, 0.772, 0.7809999999999999, 0.776, 0.77], [0.7739999999999999, 0.7729999999999999, 0.785, 0.7769999999999999, 0.7879999999999999, 0.785, 0.781, 0.786, 0.7769999999999999, 0.7689999999999999, 0.772, 0.762, 0.763, 0.79, 0.783, 0.787, 0.772, 0.772, 0.791, 0.7819999999999999, 0.792, 0.783, 0.8009999999999999, 0.785, 0.785, 0.772, 0.772, 0.784, 0.778, 0.772, 0.772, 0.776, 0.7769999999999999, 0.7929999999999999, 0.7889999999999999, 0.777, 0.7779999999999999, 0.761, 0.774, 0.7689999999999999, 0.7709999999999999, 0.765, 0.773, 0.772, 0.772, 0.7709999999999999, 0.772, 0.772, 0.795, 0.781]])

bo_50_cm = np.array([[0.0, 1.0414999999999999, 0.506, 0.3545, 1.4324999999999999, 1.275, 0.0, 0.0, 0.0, 0.0, 1.2439999999999998, 0.0, 1.0465, 1.6755, 0.0, 1.5675000000000001, 1.35, 1.3635, 0.892, 1.7015, 1.5910000000000002, 1.7805, 1.7105000000000001, 1.405, 1.5835, 0.0, 1.7195, 1.6075, 1.4245, 1.353, 1.4655, 1.751, 1.6199999999999999, 1.7445, 1.5835000000000001, 1.5810000000000002, 0.0, 0.0, 1.3565, 1.5550000000000002, 1.5615, 1.6830000000000003, 1.7395, 1.7195, 1.7149999999999999, 1.7289999999999999, 1.7205, 1.7954999999999999, 1.691, 1.7429999999999999], [0.175, 0.0, 0.6625, 0.6955, 0.36550000000000005, 0.02, 0.344, 0.0, 0.7190000000000001, 0.8655000000000002, 0.3645, 1.3615, 1.206, 0.0, 0.8210000000000001, 1.383, 0.687, 0.0, 1.3239999999999998, 1.4025, 1.2194999999999998, 1.568, 0.0, 1.6779999999999997, 0.869, 1.3105, 0.0, 1.142, 1.2049999999999998, 1.5305, 1.2335, 0.8560000000000001, 0.5235, 1.7035, 1.6875, 1.5925, 1.483, 1.5314999999999999, 1.6425, 1.6695, 1.6809999999999998, 1.7100000000000002, 1.69, 1.6595, 1.6674999999999998, 1.6355, 1.702, 1.722, 1.5495, 1.6490000000000002], [1.6744999999999997, 0.6789999999999999, 1.2095, 1.026, 1.6844999999999999, 0.18, 0.19, 0.7195, 0.5475000000000001, 1.7559999999999998, 0.8870000000000001, 0.0, 1.2315, 1.3820000000000001, 1.5619999999999998, 0.0, 0.0, 1.7175, 1.718, 1.7064999999999997, 0.1705, 0.0, 0.0, 1.3685, 0.686, 0.0, 1.45, 1.3545, 0.0, 0.0, 1.7495, 1.6664999999999999, 1.5429999999999997, 1.375, 1.3815000000000002, 1.026, 1.5470000000000002, 1.7155, 1.5724999999999998, 0.0, 1.3495000000000001, 1.5045000000000002, 1.698, 1.5130000000000001, 1.5159999999999998, 1.7185000000000001, 1.7109999999999999, 1.6150000000000002, 1.5314999999999999, 1.7195], [0.5235000000000001, 0.020999999999999998, 0.0, 0.0, 0.0, 0.0, 1.214, 0.688, 0.0, 0.8480000000000001, 1.7200000000000002, 0.0, 0.0, 1.54, 1.721, 1.7224999999999997, 1.7090000000000003, 0.0, 1.5015, 1.3565, 1.3945, 0.0, 1.0605, 1.6954999999999998, 0.0, 1.6989999999999998, 1.0074999999999998, 1.725, 1.7335, 1.5665, 1.2254999999999998, 1.535, 1.6969999999999998, 1.0550000000000002, 0.9915, 1.3954999999999997, 0.5005, 1.546, 0.0, 1.3865, 1.7384999999999997, 1.7154999999999998, 1.7469999999999999, 1.705, 1.7080000000000002, 1.7120000000000002, 1.6829999999999998, 0.0, 1.7195, 1.5604999999999998], [0.8724999999999999, 0.525, 1.5655000000000001, 1.703, 0.5325, 1.7025, 0.0, 0.522, 0.0, 0.0, 1.746, 0.0, 1.535, 1.3275000000000001, 1.6865, 1.5710000000000002, 0.0, 1.7215, 1.7, 0.8710000000000001, 0.6615, 0.0, 1.698, 1.684, 1.7114999999999998, 1.6350000000000002, 1.5125, 1.4895, 1.655, 1.4985, 1.659, 1.5399999999999998, 1.5335, 1.4055, 1.616, 1.5234999999999999, 1.3820000000000001, 0.9894999999999999, 1.6960000000000002, 1.7215, 1.208, 1.7015, 1.6939999999999997, 1.3905, 1.5475, 1.207, 1.7309999999999999, 1.575, 1.6965, 1.4955000000000003]])

dqn_50_cm = np.array([[1.595, 0.0, 1.733, 1.714, 1.739, 1.729, 0.855, 0.0, 0.0, 0.338, 1.393, 0.356, 0.0, 1.574, 1.704, 1.68, 0.0, 1.23, 0.0, 1.692, 1.736, 1.694, 1.211, 0.0, 1.554, 1.393, 1.704, 0.858, 0.862, 0.866, 0.986, 1.527, 1.684, 0.848, 0.736, 0.688, 1.697, 1.748, 1.597, 0.837, 0.0, 0.549, 1.368, 1.749, 1.714, 0.509, 1.357, 0.355, 0.882, 0.0], [0.339, 0.0, 1.716, 1.564, 0.879, 1.378, 1.724, 1.649, 1.741, 1.699, 1.697, 1.556, 1.6, 1.583, 1.531, 1.54, 1.706, 0.34, 0.704, 0.0, 1.682, 1.696, 1.668, 1.029, 0.349, 1.719, 1.722, 0.708, 0.361, 1.527, 1.659, 1.68, 0.888, 0.874, 0.884, 0.989, 1.685, 0.862, 1.693, 1.726, 1.556, 1.393, 1.063, 1.394, 0.903, 0.692, 1.56, 0.342, 1.227, 1.52], [1.721, 0.0, 1.4, 0.179, 0.891, 1.727, 0.524, 1.73, 1.533, 0.862, 0.998, 1.533, 1.04, 1.245, 0.847, 0.333, 1.702, 1.773, 0.522, 1.713, 1.054, 1.237, 0.332, 1.248, 1.746, 1.737, 1.73, 0.51, 1.187, 1.234, 0.886, 0.523, 0.524, 1.729, 1.67, 1.741, 1.039, 0.582, 1.326, 1.692, 1.044, 1.036, 0.0, 1.392, 1.66, 1.688, 0.0, 0.52, 1.554, 1.686], [1.715, 0.0, 1.758, 1.547, 1.376, 1.678, 1.667, 1.157, 1.547, 1.567, 1.331, 1.707, 0.694, 1.689, 1.686, 1.192, 0.895, 0.0, 1.179, 0.689, 1.72, 1.336, 1.731, 1.049, 0.731, 1.017, 0.682, 0.0, 1.729, 1.743, 0.181, 1.214, 1.698, 1.39, 0.528, 1.043, 0.709, 0.0, 1.704, 1.693, 1.707, 1.012, 1.175, 1.68, 0.893, 0.879, 1.759, 1.223, 1.226, 0.846], [1.044, 1.316, 0.178, 0.862, 1.722, 0.34, 0.0, 1.571, 1.6, 1.545, 0.838, 0.72, 1.368, 1.567, 1.05, 1.679, 1.06, 1.73, 1.224, 0.182, 1.728, 1.203, 0.0, 1.045, 1.498, 0.0, 0.352, 0.0, 1.725, 1.73, 1.682, 0.873, 1.023, 0.9, 1.701, 1.712, 1.353, 1.725, 1.191, 1.175, 1.032, 0.872, 1.554, 1.216, 1.068, 1.714, 1.02, 0.855, 1.081, 1.383]])

dqn_50_sp = np.array([[0.758, 0.773, 0.787, 0.773, 0.794, 0.787, 0.782, 0.785, 0.774, 0.786, 0.782, 0.778, 0.779, 0.783, 0.767, 0.769, 0.782, 0.775, 0.769, 0.785, 0.787, 0.775, 0.775, 0.772, 0.779, 0.78, 0.786, 0.791, 0.779, 0.781, 0.782, 0.782, 0.772, 0.768, 0.774, 0.786, 0.787, 0.774, 0.785, 0.778, 0.772, 0.772, 0.769, 0.77, 0.785, 0.773, 0.772, 0.791, 0.788, 0.79], [0.771, 0.779, 0.775, 0.779, 0.773, 0.769, 0.78, 0.784, 0.783, 0.791, 0.78, 0.778, 0.788, 0.774, 0.774, 0.781, 0.776, 0.767, 0.778, 0.775, 0.777, 0.788, 0.768, 0.772, 0.761, 0.789, 0.774, 0.776, 0.774, 0.783, 0.771, 0.773, 0.769, 0.782, 0.777, 0.785, 0.774, 0.778, 0.776, 0.77, 0.786, 0.78, 0.776, 0.779, 0.778, 0.769, 0.787, 0.774, 0.773, 0.781], [0.788, 0.769, 0.788, 0.789, 0.785, 0.783, 0.759, 0.773, 0.791, 0.765, 0.785, 0.784, 0.774, 0.778, 0.774, 0.798, 0.79, 0.779, 0.776, 0.777, 0.777, 0.775, 0.768, 0.783, 0.765, 0.78, 0.781, 0.782, 0.779, 0.784, 0.787, 0.795, 0.774, 0.782, 0.777, 0.775, 0.774, 0.771, 0.783, 0.784, 0.777, 0.781, 0.774, 0.789, 0.77, 0.781, 0.77, 0.791, 0.783, 0.786], [0.776, 0.775, 0.772, 0.78, 0.794, 0.769, 0.788, 0.776, 0.763, 0.778, 0.781, 0.797, 0.786, 0.78, 0.787, 0.777, 0.762, 0.777, 0.789, 0.786, 0.775, 0.787, 0.797, 0.773, 0.777, 0.772, 0.783, 0.781, 0.774, 0.784, 0.772, 0.768, 0.776, 0.785, 0.777, 0.785, 0.77, 0.767, 0.784, 0.769, 0.784, 0.8, 0.771, 0.789, 0.777, 0.78, 0.79, 0.774, 0.78, 0.776], [0.773, 0.772, 0.786, 0.78, 0.782, 0.772, 0.771, 0.774, 0.775, 0.781, 0.784, 0.773, 0.791, 0.786, 0.767, 0.787, 0.782, 0.784, 0.774, 0.79, 0.779, 0.781, 0.776, 0.771, 0.769, 0.776, 0.778, 0.786, 0.79, 0.782, 0.785, 0.782, 0.783, 0.768, 0.793, 0.783, 0.769, 0.782, 0.791, 0.779, 0.776, 0.785, 0.775, 0.77, 0.785, 0.773, 0.783, 0.777, 0.792, 0.779]])

ppo_10_cm = np.array([[0.0, 1.659, 0.0, 1.716, 1.738, 1.708, 1.704, 1.755, 1.743, 1.732], 
                    [0.344, 1.688, 1.755, 1.7, 1.7, 1.691, 1.215, 1.729, 1.703, 1.689], 
                    [0.522, 1.7, 1.703, 0.702, 1.718, 1.696, 1.679, 1.714, 1.744, 1.711], 
                    [1.755, 0.0, 0.0, 0.0, 0.331, 0.0, 0.324, 1.224, 0.0, 0.0], 
                    [1.005, 1.027, 1.738, 1.691, 1.748, 1.385, 1.561, 1.701, 1.74, 1.692]])

ppo_10_sp = np.array([[0.775, 0.765, 0.786, 0.792, 0.776, 0.769, 0.777, 0.776, 0.776, 0.787], [0.771, 0.781, 0.767, 0.777, 0.786, 0.777, 0.786, 0.789, 0.788, 0.771], [0.768, 0.791, 0.782, 0.773, 0.768, 0.774, 0.777, 0.773, 0.787, 0.782], [0.775, 0.764, 0.766, 0.784, 0.773, 0.793, 0.791, 0.772, 0.785, 0.795], [0.773, 0.779, 0.784, 0.79, 0.776, 0.788, 0.784, 0.782, 0.771, 0.783]])

ppo_50_sp = np.array([[0.78, 0.785, 0.785, 0.764, 0.789, 0.776, 0.783, 0.791, 0.776, 0.77, 0.777, 0.78, 0.783, 0.784, 0.79, 0.781, 0.781, 0.797, 0.796, 0.776, 0.774, 0.785, 0.775, 0.788, 0.768, 0.783, 0.788, 0.786, 0.763, 0.783, 0.787, 0.773, 0.781, 0.772, 0.781, 0.766, 0.791, 0.77, 0.779, 0.787, 0.767, 0.779, 0.788, 0.774, 0.784, 0.79, 0.787, 0.801, 0.792, 0.779], [0.78, 0.771, 0.783, 0.773, 0.777, 0.776, 0.786, 0.789, 0.759, 0.791, 0.769, 0.79, 0.777, 0.762, 0.784, 0.779, 0.786, 0.778, 0.778, 0.786, 0.785, 0.778, 0.797, 0.794, 0.773, 0.787, 0.781, 0.793, 0.784, 0.778, 0.777, 0.771, 0.775, 0.79, 0.778, 0.778, 0.78, 0.773, 0.788, 0.785, 0.783, 0.78, 0.787, 0.786, 0.78, 0.784, 0.774, 0.782, 0.788, 0.778], [0.777, 0.786, 0.78, 0.785, 0.783, 0.779, 0.765, 0.791, 0.779, 0.795, 0.768, 0.788, 0.788, 0.784, 0.782, 0.772, 0.782, 0.782, 0.782, 0.787, 0.777, 0.78, 0.788, 0.772, 0.78, 0.773, 0.79, 0.79, 0.788, 0.786, 0.78, 0.773, 0.775, 0.79, 0.78, 0.773, 0.775, 0.799, 0.786, 0.782, 0.786, 0.788, 0.784, 0.771, 0.78, 0.761, 0.783, 0.769, 0.784, 0.767], [0.775, 0.776, 0.79, 0.777, 0.797, 0.781, 0.792, 0.784, 0.786, 0.787, 0.784, 0.779, 0.782, 0.771, 0.778, 0.78, 0.769, 0.794, 0.785, 0.773, 0.78, 0.775, 0.773, 0.784, 0.777, 0.779, 0.781, 0.771, 0.779, 0.779, 0.781, 0.773, 0.758, 0.78, 0.773, 0.778, 0.77, 0.792, 0.797, 0.777, 0.786, 0.785, 0.768, 0.787, 0.776, 0.768, 0.781, 0.783, 0.776, 0.777], [0.777, 0.781, 0.789, 0.781, 0.771, 0.773, 0.793, 0.783, 0.778, 0.779, 0.769, 0.78, 0.795, 0.769, 0.778, 0.781, 0.782, 0.777, 0.774, 0.77, 0.775, 0.781, 0.768, 0.775, 0.782, 0.778, 0.782, 0.773, 0.784, 0.773, 0.768, 0.777, 0.781, 0.788, 0.792, 0.774, 0.781, 0.786, 0.781, 0.777, 0.784, 0.786, 0.778, 0.78, 0.801, 0.782, 0.781, 0.772, 0.783, 0.798]])

ppo_50_cm = np.array([[0.0, 1.51, 1.195, 1.698, 1.743, 0.0, 1.547, 0.0, 0.864, 1.715, 1.694, 0.513, 1.681, 1.358, 1.707, 0.351, 1.696, 1.692, 1.202, 1.696, 0.878, 1.7, 1.714, 0.904, 1.695, 1.695, 1.716, 1.686, 1.74, 1.362, 1.371, 1.711, 1.663, 0.0, 1.239, 1.746, 0.021, 1.032, 0.334, 1.672, 1.503, 1.712, 1.188, 1.024, 1.211, 1.743, 1.713, 1.685, 0.0, 1.709], [1.001, 1.737, 0.0, 1.661, 0.0, 1.667, 1.679, 1.669, 0.807, 1.725, 1.715, 1.714, 1.375, 1.727, 1.732, 0.0, 1.709, 0.481, 1.545, 0.35, 1.733, 1.699, 1.666, 0.869, 1.722, 1.744, 1.026, 1.667, 1.192, 1.688, 0.0, 1.735, 1.568, 1.708, 0.102, 1.72, 1.695, 0.876, 1.722, 1.674, 0.713, 0.396, 1.337, 1.623, 1.698, 1.712, 1.728, 1.411, 1.725, 1.701], [0.0, 1.671, 1.219, 1.741, 0.555, 0.367, 1.243, 1.683, 1.747, 1.709, 1.683, 0.0, 1.703, 1.692, 1.692, 0.0, 1.705, 1.675, 1.714, 1.666, 1.673, 1.7, 1.548, 1.224, 1.342, 1.711, 1.497, 1.677, 0.56, 1.674, 1.699, 1.722, 0.894, 1.718, 1.68, 1.217, 1.746, 1.711, 0.677, 1.733, 0.53, 0.496, 1.527, 1.735, 0.0, 1.702, 0.0, 1.731, 1.698, 1.693], [1.704, 1.509, 0.0, 1.722, 1.2, 1.716, 0.888, 0.0, 0.484, 1.163, 1.724, 0.0, 1.512, 0.337, 0.0, 1.21, 0.182, 1.745, 1.203, 0.17, 1.714, 1.669, 0.735, 1.729, 1.57, 0.879, 1.694, 1.726, 1.544, 1.208, 1.562, 1.724, 0.907, 0.506, 0.513, 1.652, 0.35, 1.762, 1.707, 1.709, 1.679, 1.595, 1.687, 1.695, 1.337, 1.727, 1.716, 1.748, 0.85, 1.551], [0.338, 1.544, 0.0, 1.666, 1.671, 0.0, 1.538, 0.513, 1.735, 1.718, 1.713, 1.704, 1.674, 1.709, 1.681, 1.196, 0.0, 1.714, 0.0, 1.329, 0.0, 1.752, 0.0, 1.226, 1.343, 1.688, 1.733, 0.543, 1.695, 0.0, 1.299, 0.0, 1.687, 1.725, 0.702, 1.711, 1.677, 1.692, 1.7, 1.68, 1.744, 1.719, 1.683, 1.698, 1.224, 1.364, 1.209, 1.689, 1.682, 1.085]])

def get_best_performance_run(array):
    maxes = np.max(array, axis=1)
    mean = np.mean(maxes) # Max performance per run
    std = np.std(maxes)
    return [mean, std]

if __name__ == "__main__":
    # 2-D array: (runs, trials)
    
    # k = 4   # use 4 for 10-trial runs, 20 for 50-trial runs
    # for name, rew in [("DQN", dqn_10_cm),
    #                 ("PPO", ppo_10_cm),
    #                 ("RS",  rs_10_cm),
    #                 ("BO", bo_10_cm)]:
    #     info = sr_ci(rew, k)
    #     print(f"{name}: {info['mean']:.2f}  "
    #         f"95% CI [{info['ci_low']:.2f}, {info['ci_high']:.2f}], {np.median(gpc(rew, k))}")
    
    # Function to calculate trials to 95% of best performance
    def trials_to_95_percent(array, budget):
        best_perf = np.max(array)
        trials_list = []
        for run in array:
            reached = np.where(run >= 0.95 * best_perf)[0]
            trials = reached[0] + 1 if len(reached) > 0 else budget
            trials_list.append(trials)
        return np.array(trials_list)


    # Calculate trials for each method and budget

    means = np.array([
    [get_best_performance_run(rs_10_cm)[0], get_best_performance_run(bo_10_cm)[0], get_best_performance_run(dqn_10_cm)[0], get_best_performance_run(ppo_10_cm)[0]],  # ComplexMaze-v0
    [get_best_performance_run(rs_10_sp)[0], get_best_performance_run(bo_10_sp)[0], get_best_performance_run(dqn_10_sp)[0], get_best_performance_run(ppo_10_sp)[0]],# Sepsis/ICU-Sepsis-v2
    ])

    # Standard deviations for each environment Ã— method
    stds = np.array([
        [get_best_performance_run(rs_10_cm)[1], get_best_performance_run(bo_10_cm)[1], get_best_performance_run(dqn_10_cm)[1], get_best_performance_run(ppo_10_cm)[1]],
        [get_best_performance_run(rs_10_sp)[1], get_best_performance_run(bo_10_sp)[1], get_best_performance_run(dqn_10_sp)[1], get_best_performance_run(ppo_10_sp)[1]],
    ])

    print(means)
    print(stds)

    # ComplexMaze
    trials_dqn_10_cm = trials_to_95_percent(dqn_10_cm, 10)
    trials_dqn_50_cm = trials_to_95_percent(dqn_50_cm, 50)
    trials_ppo_10_cm = trials_to_95_percent(ppo_10_cm, 10)
    trials_ppo_50_cm = trials_to_95_percent(ppo_50_cm, 50)
    trials_bo_10_cm = trials_to_95_percent(bo_10_cm, 10)
    trials_bo_50_cm = trials_to_95_percent(bo_50_cm, 50)
    trials_rs_10_cm = trials_to_95_percent(rs_10_cm, 10)
    trials_rs_50_cm = trials_to_95_percent(rs_50_cm, 50)

    # Sepsis
    trials_dqn_10_sp = trials_to_95_percent(dqn_10_sp, 10)
    trials_dqn_50_sp = trials_to_95_percent(dqn_50_sp, 50)
    trials_ppo_10_sp = trials_to_95_percent(ppo_10_sp, 10)
    trials_ppo_50_sp = trials_to_95_percent(ppo_50_sp, 50)
    trials_bo_10_sp = trials_to_95_percent(bo_10_sp, 10)
    trials_bo_50_sp = trials_to_95_percent(bo_50_sp, 50)
    trials_rs_10_sp = trials_to_95_percent(rs_10_sp, 10)
    trials_rs_50_sp = trials_to_95_percent(rs_50_sp, 50)

    for data in [trials_rs_50_cm, trials_bo_50_cm,trials_dqn_50_cm, trials_ppo_50_cm]:
        median = np.median(data)

        # Calculate the IQR
        q1 = np.percentile(data, 25)
        q3 = np.percentile(data, 75)
        iqr = q3 - q1

        # Calculate the standard deviation
        std_dev = np.std(data)
        print(median, iqr, std_dev)

    # Create figure with two subplots
    fig, (ax1, ax2) = plt.subplots(1, 2, figsize=(14, 6), sharey=True)

    # Methods and budgets
    methods = ['DQN', 'PPO', 'Bayesian optimisation', 'Random search']
    colors = {'10': 'lightblue', '50': 'navy'}

    legend_handles = [
        Patch(facecolor='lightblue', label='10-trial budget'),
        Patch(facecolor='navy', label='50-trial budget'),
    ]

    # Plot for ComplexMaze
    data_cm = [
        trials_dqn_10_cm, trials_dqn_50_cm,
        trials_ppo_10_cm, trials_ppo_50_cm,
        trials_bo_10_cm, trials_bo_50_cm,
        trials_rs_10_cm, trials_rs_50_cm
    ]
    positions = np.arange(len(methods)) * 1.5
    for i, method in enumerate(methods):
        box = ax1.boxplot(
            [data_cm[i * 2], data_cm[i * 2 + 1]],
            positions=[positions[i] - 0.35, positions[i] + 0.35],
            widths=0.35,
            patch_artist=True,
            whis=[0, 100],
            medianprops={'linewidth': 2, 'color': 'red'},
            showmeans=True,
            meanprops={'marker': '^', 'markerfacecolor': 'green', 'markeredgecolor': 'green', 'markersize': 5}
        )
        for patch, budget in zip(box['boxes'], ['10', '50']):
            patch.set_facecolor(colors[budget])

    ax1.axhline(y=10, color='gray', linestyle='--', alpha=0.7, label='Budget Ceiling = 10')
    ax1.axhline(y=50, color='blue', linestyle='--', alpha=0.7, label='Budget Ceiling = 50')
    ax1.set_title('ComplexMaze-v0', fontsize=12)
    ax1.set_xticks(positions)
    ax1.set_xticklabels(methods)
    ax1.set_ylabel('Trials to reach 95% of maximum performance', fontsize=10)
    ax1.grid(True, linestyle='--', alpha=0.7)
    ax1.legend()

    # Plot for Sepsis
    data_sp = [
        trials_dqn_10_sp, trials_dqn_50_sp,
        trials_ppo_10_sp, trials_ppo_50_sp,
        trials_bo_10_sp, trials_bo_50_sp,
        trials_rs_10_sp, trials_rs_50_sp
    ]
    for i, method in enumerate(methods):
        box = ax2.boxplot(
            [data_sp[i * 2], data_sp[i * 2 + 1]],
            positions=[positions[i] - 0.35, positions[i] + 0.35],
            widths=0.35,
            patch_artist=True,
            whis=[0, 100],
            medianprops={'linewidth': 2, 'color': 'red'},
            showmeans=True,
            meanprops={'marker': '^', 'markerfacecolor': 'green', 'markeredgecolor': 'green', 'markersize': 5}
        )
        for patch, budget in zip(box['boxes'], ['10', '50']):
            patch.set_facecolor(colors[budget])

    ax2.axhline(y=10, color='gray', linestyle='--', alpha=0.7, label='Budget Ceilings')
    ax2.axhline(y=50, color='blue', linestyle='--', alpha=0.7)
    ax2.set_title('Sepsis/ICU-Sepsis-v2', fontsize=12)
    ax2.set_xticks(positions)
    ax2.set_xticklabels(methods)
    ax2.grid(True, linestyle='--', alpha=0.7)
    ax2.legend()
    ax2.legend(handles=legend_handles, loc='upper right')

    plt.tight_layout()
    plt.show()
    
    # ComplexMaze
    means_cm = {
        'DQN_10': np.mean(get_best_performance(dqn_10_cm)),
        'DQN_50': np.mean(get_best_performance(dqn_50_cm)),
        'PPO_10': np.mean(get_best_performance(ppo_10_cm)),
        'PPO_50': np.mean(get_best_performance(ppo_50_cm)),
        'Bayesian optimisation_10': np.mean(get_best_performance(bo_10_cm)),
        'Bayesian optimisation_50': np.mean(get_best_performance(bo_50_cm)),
        'Random search_10': np.mean(get_best_performance(rs_10_cm)),
        'Random search_50': np.mean(get_best_performance(rs_50_cm))
    }
    stds_cm = {
        'DQN_10': np.std(get_best_performance(dqn_10_cm)),
        'DQN_50': np.std(get_best_performance(dqn_50_cm)),
        'PPO_10': np.std(get_best_performance(ppo_10_cm)),
        'PPO_50': np.std(get_best_performance(ppo_50_cm)),
        'Bayesian optimisation_10': np.std(get_best_performance(bo_10_cm)),
        'Bayesian optimisation_50': np.std(get_best_performance(bo_50_cm)),
        'Random search_10': np.std(get_best_performance(rs_10_cm)),
        'Random search_50': np.std(get_best_performance(rs_50_cm))
    }

    # Sepsis
    means_sp = {
        'DQN_10': np.mean(get_best_performance(dqn_10_sp)),
        'DQN_50': np.mean(get_best_performance(dqn_50_sp)),
        'PPO_10': np.mean(get_best_performance(ppo_10_sp)),
        'PPO_50': np.mean(get_best_performance(ppo_50_sp)),
        'Bayesian optimisation_10': np.mean(get_best_performance(bo_10_sp)),
        'Bayesian optimisation_50': np.mean(get_best_performance(bo_50_sp)),
        'Random search_10': np.mean(get_best_performance(rs_10_sp)),
        'Random search_50': np.mean(get_best_performance(rs_50_sp))
    }
    stds_sp = {
        'DQN_10': np.std(get_best_performance(dqn_10_sp)),
        'DQN_50': np.std(get_best_performance(dqn_50_sp)),
        'PPO_10': np.std(get_best_performance(ppo_10_sp)),
        'PPO_50': np.std(get_best_performance(ppo_50_sp)),
        'Bayesian optimisation_10': np.std(get_best_performance(bo_10_sp)),
        'Bayesian optimisation_50': np.std(get_best_performance(bo_50_sp)),
        'Random search_10': np.std(get_best_performance(rs_10_sp)),
        'Random search_50': np.std(get_best_performance(rs_50_sp))
    }


    # Wilcoxon signed-rank test for p-values
    def get_p_values(data_10, data_50):
        best_10 = get_best_performance(data_10)
        best_50 = get_best_performance(data_50)
        stat, p = wilcoxon(best_10, best_50)
        return p if p < 0.05 else None  # Only show significant p-values


    p_values_cm = {
        'DQN': get_p_values(dqn_10_cm, dqn_50_cm),
        'PPO': get_p_values(ppo_10_cm, ppo_50_cm),
        'Bayesian optimisation': get_p_values(bo_10_cm, bo_50_cm),
        'Random search': get_p_values(rs_10_cm, rs_50_cm)
    }
    p_values_sp = {
        'DQN': get_p_values(dqn_10_sp, dqn_50_sp),
        'PPO': get_p_values(ppo_10_sp, ppo_50_sp),
        'Bayesian optimisation': get_p_values(bo_10_sp, bo_50_sp),
        'Random search': get_p_values(rs_10_sp, rs_50_sp)
    }


    # Determine rank changes for asterisks
    def get_ranks(means, methods=['DQN', 'PPO', 'Bayesian optimisation', 'Random search']):
        ranks_10 = sorted([(means[f'{m}_10'], m) for m in methods], reverse=True)
        ranks_50 = sorted([(means[f'{m}_50'], m) for m in methods], reverse=True)
        rank_dict_10 = {m: i + 1 for i, (_, m) in enumerate(ranks_10)}
        rank_dict_50 = {m: i + 1 for i, (_, m) in enumerate(ranks_50)}
        return {m: rank_dict_10[m] != rank_dict_50[m] for m in methods}


    rank_changes_cm = get_ranks(means_cm)
    rank_changes_sp = get_ranks(means_sp)

    # Create figure with two subplots
    fig, (ax1, ax2) = plt.subplots(1, 2, figsize=(14, 6), sharey=True)

    # Methods, budgets, and colors
    methods = ['DQN', 'PPO', 'Bayesian optimisation', 'Random search']
    budgets = ['10', '50']
    colors = sns.color_palette("colorblind", 4)  # Color-blind safe palette
    bar_width = 0.18  # 0.8 * group spacing (0.225 = 0.18 / 0.8)
    positions = np.arange(len(budgets)) * 1.5

    # Determine y-axis limits
    all_means = list(means_cm.values()) + list(means_sp.values())
    all_stds = list(stds_cm.values()) + list(stds_sp.values())
    y_max = max([m + s for m, s in zip(all_means, all_stds)]) * 1.1
    y_min = min([m - s for m, s in zip(all_means, all_stds)]) * 0.9
    y_min = min(y_min, 0)  # Ensure non-negative if data allows

    # Plot for ComplexMaze
    rs_50_best_cm = np.max(rs_50_cm)  # Best RS-50 value for ComplexMaze
    for i, method in enumerate(methods):
        means = [means_cm[f'{method}_10'], means_cm[f'{method}_50']]
        stds = [stds_cm[f'{method}_10'], stds_cm[f'{method}_50']]
        pos = [positions[j] + i * bar_width for j in range(len(budgets))]
        bars = ax1.bar(
            pos, means, bar_width, yerr=stds, capsize=5,
            color=colors[i], label=method
        )
        for j, p in enumerate(pos):
            ax1.text(p, means[j] + stds[j] + 0.02 * y_max, f'{means[j]:.3f}',
                     ha='center', va='bottom', fontsize=8)
        # Add asterisks for rank changes
        if rank_changes_cm[method]:
            for j, p in enumerate(pos):
                ax1.text(p, means[j] + stds[j] + 0.05 * y_max, '*', ha='center', va='bottom', fontsize=12)
        # Add p-value brackets for significant changes
        if p_values_cm[method] is not None:
            ax1.text(pos[0] + bar_width / 2, means[0] + stds[0] + 0.1 * y_max,
                     f'p={p_values_cm[method]:.3f}', ha='center', va='bottom', fontsize=8)

    ax1.axhline(y=rs_50_best_cm, color='gray', linestyle='--', alpha=0.7, label='Random search-50 Best')
    ax1.set_title('(a) ComplexMaze-v0', fontsize=12)
    ax1.set_xticks(positions + bar_width * 1.5)
    ax1.set_xticklabels(['10 trials', '50 trials'])
    ax1.set_ylabel('Mean best performance across runs', fontsize=10)
    ax1.set_ylim(y_min, y_max)
    ax1.grid(True, linestyle='--', alpha=0.7, axis='y')
    ax1.legend()

    # Plot for Sepsis
    rs_50_best_sp = np.max(rs_50_sp)  # Best RS-50 value for Sepsis
    for i, method in enumerate(methods):
        means = [means_sp[f'{method}_10'], means_sp[f'{method}_50']]
        stds = [stds_sp[f'{method}_10'], stds_sp[f'{method}_50']]
        pos = [positions[j] + i * bar_width for j in range(len(budgets))]
        bars = ax2.bar(
            pos, means, bar_width, yerr=stds, capsize=5,
            color=colors[i], label=method
        )
        for j, p in enumerate(pos):
            ax2.text(p, means[j] + stds[j] + 0.02 * y_max, f'{means[j]:.3f}',
                     ha='center', va='bottom', fontsize=8)
        if rank_changes_sp[method]:
            for j, p in enumerate(pos):
                ax2.text(p, means[j] + stds[j] + 0.05 * y_max, '*', ha='center', va='bottom', fontsize=12)
        if p_values_sp[method] is not None:
            ax2.text(pos[0] + bar_width / 2, means[0] + stds[0] + 0.1 * y_max,
                     f'p={p_values_sp[method]:.3f}', ha='center', va='bottom', fontsize=8)

    ax2.axhline(y=rs_50_best_sp, color='gray', linestyle='--', alpha=0.7, label='Random search-50 Best')
    ax2.set_title('(b) Sepsis/ICU-Sepsis-v2', fontsize=12)
    ax2.set_xticks(positions + bar_width * 1.5)
    ax2.set_xticklabels(['10 trials', '50 trials'])
    ax2.set_ylim(y_min, y_max)
    ax2.grid(True, linestyle='--', alpha=0.7, axis='y')
    ax2.legend()

    plt.tight_layout()
    plt.show()